/**
 *
 * character = {
 *   // (string) - unique character class
 *   class: String,
 *
 *   // (Number) - character level
 *   level: 1,
 *
 *   // (array of strings) - refer to global actions this character can perform
 *   actions: ['status', 'equip'],
 *
 *   // (object) of specific properties, each property's value is an item object
 *   equipment: {
 *     weapon: {item},
 *     armor: {item},
 *     gear: {item}
 *   },
 *
 *   // (object) of specific properties, each property's value is a number
 *   attributes: {
 *     body: Number,
 *     mind: Number,
 *     spirit: Number,
 *     hp: Number
 *   },
 *
 *   // (array) of item objects
 *   items:[
 *     {item},
 *     {item}
 *   ],
 *
 *   // (adventure object) - the character's current adventure
 *   adventure: {},
 *
 *   // (Number) - encounter array index
 *   // current_encounter: 0,
 * }
 */
var _ = require('lodash');
var Buff = require('buff');
var tools = require('tools');

var Character = function( stub ){

  // merge stub into object
  if ( typeof stub === 'object' ) {
    _.merge(this, stub );
  }
  
  // reset the total value of buffs per attribute
  this.buff_totals = {
    body: 0,
    mind: 0,
    spirit: 0,
    hp: 0
  };

  // do the math to get buff totals.
  this.findBuffTotals();
};

// character factor
Character.create = function( stub ){
  return new Character( stub );
};

/**
 * Default properties and methods
 */
Character.prototype = {

  name: '',
  class: {},
  level: 0,
  xp: 0,
  gp: 0,
  hp: 1,
  actions: [],
  equipment: {
    weapon: {},
    armor: {},
    gear: {}
  },
  attributes: {
    body: 0,
    mind: 0,
    spirit: 0,
    hp: 0
  },
  // the buff objects attached to this character
  buffs: [],

  items: [],
  adventure: {},
  current_encounter: 0,


  /**
   * Level up the character
   */
  levelUp: function () {
    this.xp = 0;
    this.level++;
    console.log("You have reached a new level of skill!");
    console.log("You are now a level "+this.level+" "+this.class.name+"!");

    // body
    if (this.class.attributes.body == "strong") {
      if (tools.random(0,1)) this.body++;
      this.body++;
    } else if (this.class.attributes.body == "weak") {
      if (tools.random(0,1)) this.body++;
    } else {
      this.attributes.body++;
    }

    // mind
    if (this.class.attributes.mind == "strong") {
      if (tools.random(0,1)) this.mind++;
      this.mind++;
    } else if (this.class.attributes.mind == "weak") {
      if (tools.random(0,1)) this.mind++;
    } else {
      this.attributes.mind++;
    }

    // spirit
    if (this.class.attributes.spirit == "strong") {
      if (tools.random(0,1)) this.spirit++;
      this.spirit++;
    } else if (this.class.attributes.spirit == "weak") {
      if (tools.random(0,1)) this.spirit++;
    } else {
      this.attributes.spirit++;
    }

    // hp
    if (this.class.attributes.hp == "strong") {
      if (tools.random(0,1)) this.hp++;
      this.hp++;
    } else if (this.class.attributes.hp == "weak") {
      if (tools.random(0,1)) this.hp++;
    } else {
      this.attributes.hp++;
    }
  },

  /**
   * Get an attribute's base value
   *
   * @param attr
   * @returns {*}
   */
  getAttr: function( attr ){
    if ( this.attributes[ attr ] ) {
      return this.attributes[ attr ];
    }

    return 0;
  },

  /**
   * Get the buff value of an attribute
   *
   * @param attr
   * @return int
   */
  getAttrBuff: function( attr ){
    if ( this.buff_totals[ attr ] ){
      return this.buff_totals[ attr ];
    }

    return 0;
  },

  /**
   * Get the total value of an attribute and its buffs
   *
   * @param attr
   * @return integer
   */
  getAttrTotal: function( attr ) {
    return this.getAttr( attr ) + this.getAttrBuff( attr );
  },

  /**
   * Gather the bonuses/buffs for this character into the this.buffs object
   */
  findBuffTotals: function() {
    var buff_totals = this.buff_totals;

    for( var i = 0; i < this.buffs.length; i++ ){
      // this buff object
      var buff = this.buffs[ i ];

      if ( this.attributes[ buff.attribute ] ) {
        // add the buff amount to the totals
        buff_totals[ buff.attribute ] += buff.amount;
      }
    }

    this.buff_totals = buff_totals;
  },

  /**
   * Add a new buff to this character
   */
  addBuff: function( stub ){
    var buff = new Buff( stub );
    this.buffs.push( buff );

    // chain
    return this;
  },

  /**
   *
   * @param name
   * @returns {boolean}
   */
  hasBuff: function( name ){
    for( var i = 0; i < this.buffs.length; i++ ){
      var buff = this.buffs[ i ];
      if (buff.name == name){
        return true;
      }
    }
    return false;
  },

  /**
   * Decrement the duration of each buff, and remove any that have expired
   */
  expireBuffs: function(){
    var remaining_buffs = [];

    if ( this.buffs.length ){
      for ( var i = 0; i < this.buffs.length; i ++ ) {
        var buff = this.buffs[ i ];

        buff.duration = parseInt( buff.duration ) - 1;

        if ( buff.duration !== 0 ){
          remaining_buffs.push(buff);
        }
      }
    }

    this.buffs = remaining_buffs;
  }
};

module.exports = Character;