var fs = require('fs');
var _ = require('lodash');

/**
 * Helpful tools when dealing with files of stubs
 */
module.exports = {

  /**
   *
   * @returns {Array}
   */
  getAllEncounters: function () {
    var encounters = [];

    // load encounter stubs
    fs.readdirSync('game/static/encounters').forEach(function (filename) {
      // load all stubs
      var stubs = require('../static/encounters/' + filename);

      // loop through stubs and add to encounters list
      for( var i = 0; i < stubs.length; i++ ){
        var stub = _.clone( stubs[i] );
        // remember this is a stub, and where it came from
        stub.is_stub = true;
        stub.filename = filename;
        stub.index = i;

        encounters.push( stub );
      }
    });

    return encounters;
  },

  /**
   * get single encounter by its filename and index
   *
   * @param filename
   * @param index
   * @returns encounter
   */
  getEncounter: function ( filename, index ) {
    var encounter = {};
    var path = require('path');
    var filepath = path.normalize(__dirname + '/../static/encounters/');

    if ( fs.existsSync( filepath + filename ) ) {
      var file = require( filepath + filename );

      console.log('-- found file: ' + filepath + filename );

      // encounters could be in an array of stubs, or an adventure object
      // an array of stubs uses the index directly
      if ( Array.isArray( file ) ){
        console.log("is array of stubs");
        console.log(index);
        //console.log(file);
        encounter = _.clone( file[ index ] );
      }
      // it may also contain an array of encounters
      else if ( typeof file === 'object' && file.encounters ) {
        console.log("is array of encounters");
        encounter = _.clone( file.encounters[ index ] );
      }
      else {
        console.log("NOT FOUND");
        encounter.title = "NOT FOUND";
      }

      console.log(encounter);
      // remember
      encounter.is_stub = true;
      encounter.filename = filename;
      encounter.index = index;
    }

    return encounter;
  },

  /**
   * Ger all adventure stubs that aren't single files
   */
  getAllAdventures: function () {
    var adventures = [];
    var _this = this;
    // load all stubs
    var stubs = require('../static/adventures/stubs.js');

    // loop through stubs and add to encounters list
    for( var i = 0; i < stubs.length; i++ ){

      var stub = _.clone( stubs[i] );
      // remember this is a stub, and where it came from
      stub.is_stub = true;
      stub.filename = 'stubs.js';
      stub.index = i;

      adventures.push( stub );
    }
    return adventures;
    //return require('../static/adventures/stubs');
  },

  /**
   * Get a single adventure from stub
   *
   * @param filename
   * @param index
   * @returns adventure
   */
  getAdventure: function ( filename, index ) {
    var adventure = {};
    var path = require('path');
    var filepath = path.normalize(__dirname + '/../static/adventures/');

    if ( fs.existsSync( filepath + filename) ) {
      var file = require( filepath + filename );

      console.log('-- found file: ' + filepath + filename + ' - index: ' + index);

      if ( Array.isArray( file ) ){
        console.log("---------\n---------\n----------- adventure is stubs array");
        // this file is an array of adventure stubs
        adventure = _.clone(file[ index ]);
        adventure.index = index;
      }
      else {
        // this file should be a single adventure stub
        adventure = _.clone(file);
        console.log(file);
        console.log('------- single adventure file found');

        // loop through encounters and assign some meta data
        for( var i = 0; i < adventure.encounters.length; i++ ){
          adventure.encounters[ i ].is_stub = true;
          adventure.encounters[ i ].filename = filename;
          adventure.encounters[ i ].index = i;
        }
      }

      // remember where this came from
      adventure.is_stub = true;
      adventure.filename = filename;
    }
    else {
      console.log("file doesn't exist: "+filepath+filename);
    }

    return adventure;
  },
  
  /**
   * Get all classes from the class directory
   *
   * @returns array
   */
  getAllClasses: function () {
    var classes = [];
    var _this = this;
    // load encounter stubs
    fs.readdirSync('game/static/classes').forEach(function (filename) {
      var stub = _this.getClass(filename);
      if( stub ) {
        classes.push(stub);
      }
    });
    return classes;
  },   
  
  /**
   * Get a single class from stub
   *
   * @param filename
   * @param index
   * @returns adventure
   */
  getClass: function ( filename ) {
    var classstub = false;
    var path = require('path');
    var filepath = path.normalize(__dirname + '/../static/classes/');
    var classfile = filepath + filename;
    
    if ( fs.existsSync( classfile ) ) {               
      var classstub = require( classfile );       

      console.log('-- found file: ' + classfile );

      classstub.filename = filename;
    }
    else {
      console.log("file doesn't exist: "+filepath+filename);
    }

    return classstub;
  },
   
}