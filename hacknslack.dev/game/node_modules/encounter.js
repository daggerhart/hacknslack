/**
 * An encounter is a step (or state) in the player's game.
 *
 * encounter = {
 *   // (string)
 *   title: "What do you want to to?",
 *
 *   // (string)
 *   desc: "You are presented with the following choices...",
 *
 *   // (array of strings)
 *   tags: ['monster', 'arcane'],
 *
 *   // (array of action objects or strings that reference global actions) - this encounterâ€™s contextual actions
 *   actions: [
 *     {
 *       cmd: "attack",
 *       text: "Attack !"
 *     },
 *     { action object },
 *     'attack' // as a string to reference a global action
 *   ],
 *
 *   // (number) - difficulty of encounter
 *   challenge_rating: 3,
 *
 *   // (string) - pc attribute the difficulty challenges
 *   challenge_attribute: 'body',
 *
 *   // (mixed) - array of effect objects or a callback
 *   success : [
 *     { effect object },
 *     { effect object }
 *   ],
 *
 *   // (mixed) - array of objects or a callback
 *   fail : [
 *     { effect object },
 *     { effect object }
 *   ]
 * }
 */

var _ = require('lodash');
var tools = require('tools');

/**
 * An encounter is a step in the player's game.
 */
var Encounter = function( stub ){
  // (bool) - this encounter was created from an encounter stub
  this.is_stub = false;

  // (bool) - where the stub came from
  this.filename = false;

  // (number) - where the encounter stub can be found in the file's array
  this.index = false;

  // (string) - title for this encounter
  this.title = '';

  // (string) - description
  this.desc = '';

  // (array) - simple way to alias the attack action:  ['cmd', 'text for the command']
  this.attack_alias = false;

  // (array of strings or action objects) - actions this encounter allows / provides
  this.actions = [];

  // (array of strings)
  this.tags = [];

  // the encounter difficulty
  this.challenge = {
    rating: 0,
    attribute: ''
  };

  // (array) of effect objects
  this.success = [];

  // (array) of effect objects
  this.fail = [];

  // generic afterLoad method
  this.afterLoad = function( Game ) {};
  
  // merge stub into object
  if ( typeof stub === 'object' ) {
    console.log('-- encounter constructor with stub');
    _.merge(this, stub);
  }

  // reload from file if encounter is a stub
  if ( this.is_stub && this.filename && this.index ){
    console.log('-- encounter reloaded from file');
    var encounterStub = tools.files.getEncounter( this.filename, this.index );

    // TODO : maybe this could be done better,
    // but what I need is for the db saved encounter data to overwrite the file stub,
    // and then have the resulting filestub overwrite this encounter.
    _.merge(encounterStub, stub);

    // reattached methods from the stub to this encounter
    _.merge( this, encounterStub);
  }

  // convert attack_alias into an action
  if ( this.attack_alias ){
    var attack_alias = {
      cmd: 'attack',
      alias: this.attack_alias[0],
      text: this.attack_alias[1]
    };

    this.actions.unshift( attack_alias );
    console.log('--------- attack alias found -------------');
    console.log('--------- '+ attack_alias.alias +' - ' + attack_alias.text + ' -------------');
  }

  // at end of the day, if this encounter has no actions we should give it 'attack'
  if ( this.actions.length === 0 ){
    this.actions.push('attack');
  }
};

module.exports = Encounter;