var Encounter     = require('encounter');
var Adventure     = require('adventure');
var globalActions = require('globalActions');
var tools         = require('tools');

var fs = require("fs");
var _  = require("lodash");

/**
 * A Game is a single execution of a player interaction with the system
 *
 * @param req
 * @constructor
 */
var Game = function( req ) {

  // request query - url $_GET vars placed into an object
  this.query = req.query;

  // request raw text input
  this.raw_input = req.query.text;

  // single game instance actions that the player can perform
  this.allowed_actions =  {}; // dynamically populated by system

  // the current player of this game
  this.player    = {};

  // the player's current character
  this.character = {};

  // the character's current adventure
  this.adventure = {};

  // the adventure's current encounter
  this.encounter = {};

  // response
  this.output =  {
    // slack expects a payload
    payload:  "",
    // data that will be processed into the payload for output
    data:  [],
    // array of data for json endpoint
    debug: []
  };

  /**
   * Get the next encounter on the current adventure
   */
  this.nextEncounter = function(){
    var next = this.character.current_encounter + 1;

    // TODO
    if ( this.adventure.encounters[ next ]){
      // increment to next encounter
      this.encounter = new Encounter( this.adventure.encounters[ next ] );
      this.character.current_encounter = next;
    }
    else {
      // generate a new adventure
      this.adventure = this.generateAdventure();

      // set the game encounter
      this.encounter = this.adventure.encounters[0];

      // reset current encounter
      this.character.current_encounter = 0;
    }
  };

  /**
   * Create the next adventure
   */
  this.generateAdventure = function(){
    var stub = {};
    stub.title = "Deserters!";
    stub.encounters = this.generateEncounters('bandit', 'military', 5);

    var adventure = new Adventure( stub );

    console.log('----------------- GENERATED ADVENTURE -------------');
    console.log(adventure);
    // TODO: we need adventure randomization

    //console.log('We are on the adventure: ' + this.adventure.name);

    return adventure;
  };

  /**
   * Generate random encounters
   *
   */
  this.generateEncounters = function(tag1, tag2, num_of_encounters){
    var used = [];
    var encounters = [];

    // load encounter stubs
    var all_encounters = tools.files.getAllEncounters();

    // get encounters filtered by tags
    var filtered_encounters = _.filter( all_encounters, function( enc ){
      return  ( enc.tags.indexOf( tag1 ) != -1 || enc.tags.indexOf( tag2 ) != -1 );
    });

    // loop through filtered encounters and randomly select a few
    while ( used.length < num_of_encounters ){
      // get a random encounter stub
      var rand = tools.random(0, filtered_encounters.length);

      // make sure we haven't used this encounter in the adventure so far
      if ( used.indexOf( rand ) === -1 ) {
        // keep track of encounters we've selected
        used.push(rand);

        var stub = filtered_encounters[rand];

        // make into full encounter
        var encounter = new Encounter( stub );

        //console.log('--------- CREATED NEW ENCOUNTER FROM STUB ------------');
        //console.log(encounter);

        // add effects ?

        // add to adventure
        encounters.push(encounter);
      }
    }

    return encounters;
  };


  /**
   * Get the actions provided by an object and place into Game.allowed_actions
   *
   * @param obj
   * @param context
   */
  this.getActions = function( obj, context ) {
    if ( obj.actions ) {

      for (var i = 0; i < obj.actions.length; i++) {
        // can be a string, array, or action object
        var action = obj.actions[i];

        // strings are references to global actions
        if (typeof action === 'string' &&  globalActions.actions[ action ]) {
          this.allowed_actions[ action ] = globalActions.actions[ action ];
          this.allowed_actions[ action ].context = 'global';
        }
        // actions may alias global actions
        else if ( action.alias && globalActions.actions[ action.cmd ] ) {
          // the alias is what the user can type, so
          this.allowed_actions[ action.alias ] = globalActions.actions[ action.cmd ];
          this.allowed_actions[ action.alias ].alias = action.alias; // useful for debugging
          this.allowed_actions[ action.alias ].context = 'global';
          this.allowed_actions[ action.alias ].text = action.text;
        }
        // this action is unique to the context
        else {
          this.allowed_actions[ action.cmd ] = action;
          this.allowed_actions[ action.cmd ].context = context;
        }
        console.log('got actions for context: ' + context);
      }
    }
  };

  /**
   * Execute a the current Game action
   *
   * @param done
   */
  this.doAction = function( done ){
    var action = this.allowed_actions[ this.input.action ];
    console.log('------------ DO ACTION -----------');
    console.log( action );

    var context_map = {
      global: globalActions,
      player: this.player,
      adventure: this.adventure,
      character: this.character,
      encounter: this.encounter
      // TODO equipment and items
    };

    // get the contextual object of this action
    if ( context_map[ action.context ] ) {
      var context = context_map[ action.context ];

      console.log('-------------- ACTION CONTEXT OBJECT -------------');
      console.log( context );

      var method = '';

      if ( typeof context[ action.cmd ] === 'function' ){
        method = action.cmd;

        // execute the context's method
        context[ method ]( this, function(){
          done();
        });
      }
      else {
        console.log('----------- Method not found in context -----------');
      }
    }
  };

  /**
   * Load a new adventure from file and start at first encounter
   */
  this.loadAdventure = function( adventureFileName ){
    var stub = tools.files.getAdventure( adventureFileName );

    this.adventure = new Adventure( stub );

    this.character.current_encounter = 0;
    this.encounter = new Encounter( this.adventure.encounters[0] );
  };
};

module.exports = Game;
