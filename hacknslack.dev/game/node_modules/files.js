var fs = require('fs');
var _ = require('lodash');

/**
 * Helpful tools when dealing with files of stubs
 */
module.exports = {

  /**
   *
   * @returns {Array}
   */
  getAllEncounters: function () {
    var encounters = [];

    // load encounter stubs
    fs.readdirSync('game/static/encounters').forEach(function (filename) {
      // load all stubs
      var stubs = require('../static/encounters/' + filename);

      // loop through stubs and add to encounters list
      for( var i = 0; i < stubs.length; i++ ){

        // remember this is a stub, and where it came from
        stubs[i].is_stub = true;
        stubs[i].filename = filename;
        stubs[i].index = i;

        encounters.push( stubs[i] );
      }
    });

    return encounters;
  },

  /**
   * get single encounter by its filename and index
   *
   * @param filename
   * @param index
   * @returns encounter
   */
  getEncounter: function ( filename, index ) {
    var encounter = {};
    var path = require('path');
    var filepath = path.normalize(__dirname + '/../static/encounters/');

    if ( fs.existsSync( filepath + filename ) ) {
      var file = require( filepath + filename );

      console.log('-- found file: ' + filepath + filename );

      // encounters could be in an array of stubs, or an adventure object
      // an array of stubs uses the index directly
      if ( Array.isArray( file ) ){
        encounter = file[ index ];
      }
      // it may also contain an array of encounters
      else if ( typeof file === 'object' && file.encounters ) {
        encounter = file.encounters[ index ];
      }
      else {
        encounter.title = "NOT FOUND";
      }

      // remember
      encounter.is_stub = true;
      encounter.filename = filename;
      encounter.index = index;
    }

    return encounter;
  },

  /**
   * Ger all adventure stubs that aren't single files
   */
  getAllAdventures: function () {
    //return require('../static/adventures/stubs');
  },

  /**
   * Get a single adventure from stub
   *
   * @param filename
   * @param index
   * @returns adventure
   */
  getAdventure: function ( filename, index ) {
    var adventure = {};
    var path = require('path');
    var filepath = path.normalize(__dirname + '/../static/adventures/');

    if ( fs.existsSync( filepath + filename) ) {
      var file = require( filepath + filename );

      console.log('-- found file: ' + filepath + filename );

      if ( index && Array.isArray( file ) ){
        // this file is an array of adventure stubs
        adventure = file[ index ];
        adventure.index = index;
      }
      else {
        // this file should be a single adventure stub
        adventure = file;
      }

      // loop through encounters and assign some meta data
      for( var i = 0; i < adventure.encounters.length; i++ ){
        adventure.encounters[ i ].is_stub = true;
        adventure.encounters[ i ].filename = filename;
        adventure.encounters[ i ].index = i;
      }

      // remember where this came from
      adventure.is_stub = true;
      adventure.filename = filename;
    }
    else {
      console.log("file doesn't exist: "+filepath+filename);
    }

    return adventure;
  },
  
  /**
   * Get all classes from the class directory
   *
   * @returns array
   */
  getAllClasses: function () {
    var classes = [];
    var _this = this;
    // load encounter stubs
    fs.readdirSync('game/static/classes').forEach(function (filename) {
      var stub = _this.getClass(filename);
      if( stub ) {
        classes.push(stub);
      }
    });
    return classes;
  },   
  
  /**
   * Get a single class from stub
   *
   * @param filename
   * @param index
   * @returns adventure
   */
  getClass: function ( filename ) {
    var classstub = false;
    var path = require('path');
    var filepath = path.normalize(__dirname + '/../static/classes/');
    var classfile = filepath + filename;
    
    if ( fs.existsSync( classfile ) ) {               
      var classstub = require( classfile );       

      console.log('-- found file: ' + classfile );

      classstub.filename = filename;
    }
    else {
      console.log("file doesn't exist: "+filepath+filename);
    }

    return classstub;
  },
   
}