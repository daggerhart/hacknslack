/**
 * An encounter is a step (or state) in the player's game.
 *
 * encounter = {
 *   // (string)
 *   title: "What do you want to to?",
 *
 *   // (string)
 *   desc: "You are presented with the following choices...",
 *
 *   // (array of strings)
 *   tags: ['monster', 'arcane'],
 *
 *   // (array of action objects or strings that reference global actions) - this encounterâ€™s contextual actions
 *   actions: [
 *     {
 *       cmd: "attack",
 *       text: "Attack !"
 *     },
 *     { action object },
 *     'attack' // as a string to reference a global action
 *   ],
 *
 *   // (number) - difficulty of encounter
 *   challenge_rating: 3,
 *
 *   // (string) - pc attribute the difficulty challenges
 *   challenge_attribute: 'body',
 *
 *   // (mixed) - array of effect objects or a callback
 *   success : [
 *     { effect object },
 *     { effect object }
 *   ],
 *
 *   // (mixed) - array of objects or a callback
 *   fail : [
 *     { effect object },
 *     { effect object }
 *   ]
 * }
 */
var _ = require('lodash');
var tools = require('tools');
var Effect = require('effect');
/**
 * Constructor provides default values for properties
 */
var Encounter = function(){

  // (bool) - this encounter was created from an encounter stub
  this.is_stub = false;

  // (bool) - where the stub came from
  this.filename = false;

  // (number) - where the encounter stub can be found in the file's array
  this.index = false;

  // (string) - title for this encounter
  this.title = '';

  // (string) - description
  this.desc = '';

  // (array) - simple way to alias the attack action =   ['cmd'; 'text for the command']
  this.attack_alias = false;

  // (array of strings or action objects) - actions this encounter allows / provides
  this.actions = [];

  // (array of strings)
  this.tags = [];

  // the encounter difficulty
  this.challenge = {
    rating: 0,
    attribute: ''
  };

  // (array) of effect objects
  this.success = [];

  // (array) of effect objects
  this.fail = [];
};

/**
 * Prototype of object contains default methods for all Encounter objects
 */
Encounter.prototype = {
  // generic afterLoad method
  afterLoad: function( Game ) {},

  addSuccessEffect: function( stub ){
    this.success.push( Effect.create( stub ) );
  },

  addFailEffect: function( stub ){
    this.fail.push( Effect.create( stub ) );
  }

};

/**
 * Object factor produces a new object, merges stub information, and does preprocessing
 */
Encounter.create = function( stub ){
  // blank encounter
  var encounter = new Encounter();

  // merge stub into object
  if ( typeof stub === 'object' ) {
    // reload from file if encounter is a stub
    if ( stub.is_stub && stub.filename ) {
      console.log('-- encounter reloaded from file');

      var fileStub = tools.files.getEncounter(stub.filename, stub.index);

      // merge argument stub and fileStub together
      // this let's us re-attach methods from the file
      // this stub was originally loaded from
      _.merge(fileStub, stub);

      // merge the resulting stub to this encounter
      _.merge(encounter, fileStub);

      console.log('FINAL MERGED ENCOUNTER');console.log(encounter);
    }
    else {
      console.log('-- encounter constructor with stub');
      _.merge(encounter, stub);
    }
  }

  // convert attack_alias into an action
  if ( encounter.attack_alias ){
    var attack_alias = {
      cmd: 'attack',
      alias: encounter.attack_alias[0],
      text: encounter.attack_alias[1]
    };

    encounter.actions.unshift( attack_alias );
    console.log('--------- attack alias found -------------');
    console.log('--------- '+ attack_alias.alias +' - ' + attack_alias.text + ' -------------');
  }

  // at end of the day, if this encounter has no actions we should give it 'attack'
  if ( encounter.actions.length === 0 ){
    encounter.actions.push('attack');
  }

  // add tags array if missing, and attach tag methods
  tools.initTags( encounter );

  return encounter;
};



module.exports = Encounter;